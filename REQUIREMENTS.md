# 产品需求文档 - 登录页面与会话管理功能

**版本**: v1.1
**日期**: 2025-10-14
**状态**: 待实现
**变更日志**:
- v1.1 (2025-10-14): 新增会话重命名功能

---

## 一、需求概述

本次迭代将为 WeChat Work 聊天机器人应用增加两个核心功能：
1. **侧边栏历史会话管理** - 用户可以查看、创建、切换和删除历史会话
2. **独立登录页面与登出功能** - 重构认证流程，增加独立登录页和登出能力

---

## 二、需求详情

### 需求1：侧边栏历史会话管理

#### 1.1 功能目标
- 用户可以在侧边栏查看所有历史会话列表
- 支持新建、切换、删除会话操作
- 所有会话数据通过 Coze 后端存储和获取

#### 1.2 功能规格

##### 1.2.1 会话列表展示
- **展示内容**：每个会话条目显示第一条用户消息作为会话标题
- **排序规则**：按最后活跃时间倒序排列（最新的在最上方）
- **不支持功能**：暂不支持搜索和筛选功能

##### 1.2.2 会话操作

| 操作 | 描述 | 触发方式 |
|------|------|----------|
| **查看会话列表** | 显示用户所有历史会话 | 页面加载时自动获取 |
| **新建会话** | 创建一个新的空白会话 | 点击"新建会话"按钮 |
| **切换会话** | 加载选中会话的历史消息 | 点击会话列表中的某个会话 |
| **重命名会话** | 修改会话的标题名称 | 点击会话条目的编辑按钮 |
| **删除会话** | 删除选中的会话 | 点击会话条目的删除按钮 |

##### 1.2.3 会话持久化策略
- **存储位置**：所有会话数据存储在 Coze 后端
- **获取方式**：通过 Coze API 获取用户的会话列表
- **本地缓存**：前端不做本地持久化，仅在内存中保持当前会话状态
- **数据同步**：用户在不同设备登录时，会话数据自动同步

#### 1.3 UI/UX 规格

##### 1.3.1 侧边栏布局
- **桌面端**：
  - 侧边栏固定在左侧，宽度约 280px
  - 包含顶部"新建会话"按钮和下方会话列表
  - 当前激活的会话高亮显示

- **移动端**：
  - 侧边栏默认隐藏，通过汉堡菜单按钮展开
  - 展开时以抽屉式覆盖在聊天界面上
  - 选择会话后自动收起侧边栏

##### 1.3.2 会话条目设计
```
┌─────────────────────────────────────────┐
│ [📝] 会话标题（第一条用户消息）   │ [✏️] [🗑️]
│      最后活跃时间                   │
└─────────────────────────────────────────┘
```
- 会话标题最多显示 30 个字符，超出显示省略号
- 鼠标悬停显示完整标题（tooltip）
- 编辑和删除按钮仅在鼠标悬停时显示（移动端始终显示）

##### 1.3.3 交互反馈
- **新建会话**：立即切换到新会话，清空聊天区域
- **切换会话**：显示加载动画，加载完成后展示历史消息
- **重命名会话**：
  - 点击编辑按钮后，会话标题变为可编辑的输入框
  - 输入框获得焦点，并选中当前文本
  - 用户修改后按回车或失去焦点时保存
  - 按 ESC 键取消编辑
  - 如果输入为空，则恢复原标题并提示"会话名称不能为空"
  - 保存成功后显示提示"重命名成功"
- **删除会话**：二次确认弹窗（"确认删除此会话？"）

---

### 需求2：延迟登录模式与登出功能

#### 2.1 功能目标
- 用户访问应用时可以直接看到聊天界面，无需强制登录
- 用户可以输入消息，但发送时需要登录
- 增加显式的登出功能

#### 2.2 功能规格

##### 2.2.1 登录流程（延迟登录模式）

**现有流程**：
```
用户访问 → 自动跳转企微授权 → 授权后直接进入聊天页
```

**新流程（延迟登录）**：
```
用户访问 → 显示聊天界面 → 可以输入消息 → 点击发送 →
检查登录状态 → 未登录弹出登录模态框 → 扫码授权 → 关闭模态框继续发送
```

##### 2.2.2 访问控制
- **未登录用户**：
  - 可以访问聊天页面
  - 可以输入消息内容
  - 点击发送按钮时，检查登录状态
  - 如果未登录，弹出登录模态框
- **已登录用户**：
  - 正常使用所有聊天功能
  - 侧边栏显示历史会话列表

##### 2.2.3 会话状态管理
- **本地存储策略**：前端不保存会话数据，全部依赖 Coze 后端
- **登出行为**：
  - 清除前端 localStorage 中的所有认证信息（包括 Coze token）
  - 清除后端 Express session
  - 清空内存中的会话数据
  - 重定向到登录页
- **多设备同步**：会话数据存储在 Coze，自然支持多设备同步

#### 2.3 UI/UX 规格

##### 2.3.1 登录模态框设计

**触发时机**：
- 未登录用户点击发送按钮时弹出

**模态框结构**：
```
┌─────────────────────────────────────┐
│             [×]                     │
│                                     │
│          [Logo/产品名称]             │
│                                     │
│     需要登录才能发送消息              │
│                                     │
│   ┌─────────────────────────┐      │
│   │  [企微图标] 企业微信登录  │      │
│   └─────────────────────────┘      │
│                                     │
└─────────────────────────────────────┘
```

**功能要求**：
- 模态框背景半透明遮罩
- 点击遮罩或右上角关闭按钮可关闭模态框
- 仅提供企业微信扫码登录方式
- 登录按钮样式与企微品牌风格一致
- 响应式设计，支持桌面端和移动端

**登录流程**：
1. 用户点击"企业微信登录"按钮
2. 打开新窗口跳转到企微授权页面
3. 用户扫码授权
4. 授权成功后新窗口关闭，主窗口检测到登录成功
5. 自动关闭模态框，继续发送消息

##### 2.3.2 未登录状态指示

**左下角登录按钮**（参考图片）：
- 位置：聊天界面左下角
- 样式：显示用户头像或"登录"文字
- 未登录状态：显示"登录"文字 + 图标
- 已登录状态：显示用户名或头像

**侧边栏行为**：
- 未登录用户：侧边栏不显示或显示空状态 + 登录提示
- 已登录用户：侧边栏显示会话列表

##### 2.3.3 登出功能

**触发位置**：
- 左下角用户信息区域
- 点击用户名/头像弹出菜单，包含"登出"选项

**交互流程**：
1. 用户点击用户名/头像
2. 弹出菜单显示"登出"选项
3. 点击"登出"
4. 无需二次确认，直接执行登出
5. 清除登录状态，左下角恢复为"登录"按钮
6. 侧边栏隐藏或显示空状态

---

## 三、技术实现要点

### 3.1 前端路由设计

| 路径 | 页面 | 访问控制 |
|------|------|----------|
| `/` | 重定向到 `/chat.html` | 无限制 |
| `/chat.html` | 聊天主页面（含侧边栏） | 无限制，但发送消息需要登录 |
| `/auth/callback` | 企微OAuth回调 | 处理后关闭窗口或重定向 |

### 3.2 API 端点设计

#### 3.2.1 现有端点（需调整）
- `GET /api/conversations` - 获取用户所有会话列表（已存在，确认调用 Coze API）
- `POST /api/conversations` - 创建新会话（已存在）
- `PATCH /api/conversations/:id` - 更新会话信息（重命名会话标题）
- `DELETE /api/conversations/:id` - 删除指定会话（已存在）

#### 3.2.2 调整端点
- `GET /auth/session` - 检查登录状态（已存在）
  - 返回 `{ authenticated: true/false, userId, userName }`
- `GET /auth/logout` - 登出接口（已存在，需调整）
  - 清除 session
  - 返回成功响应
  - 前端收到响应后清除 localStorage 并更新 UI 状态

#### 3.2.3 中间件调整
- 在需要认证的 API 路由上添加 auth 检查
- 未登录用户访问需认证的 API 时，返回 401 状态码
- 前端收到 401 时弹出登录模态框

### 3.3 Coze API 集成

#### 3.3.1 会话管理相关 API
根据 Coze SDK v1.3.5 文档，需要使用以下接口：
- `coze.conversations.list()` - 获取用户会话列表
- `coze.conversations.create()` - 创建新会话
- `coze.conversations.update()` - 更新会话信息（重命名）
- `coze.conversations.messages.list()` - 获取会话历史消息
- `coze.conversations.clear()` 或 `delete()` - 删除会话

> **待确认**：
> 1. Coze API 是否支持根据用户 ID 获取会话列表？如果不支持，需要在后端维护一个 userId → conversationIds 的映射表。
> 2. Coze API 是否支持更新会话的标题/名称？如果不支持，需要在后端数据库存储自定义标题。

### 3.4 前端状态管理

**用户信息存储**：
- **后端**：Express session 存储用户信息
  - `userId` - 企微用户ID（用于 Coze JWT 生成）
  - `userName` - 用户名
  - `userInfo` - 完整用户信息
  - `loginTime` - 登录时间
- **前端**：
  - localStorage 存储 Coze token（可选）
  - 内存中保持当前会话状态

**为什么必须存储用户信息**：
1. **Coze JWT 认证**：每次调用 Coze API 需要生成 JWT，JWT 需要 `userId`
2. **会话隔离**：每个用户有独立的会话列表，需要 `userId` 区分
3. **跨请求状态保持**：用户刷新页面后仍保持登录状态

**存储方案**：
- 使用现有的 Express session（基于内存或 Redis）
- Session 通过 cookie 自动关联到用户浏览器
- 登出时清除 session 和前端 localStorage

---

## 四、实现阶段规划

### Stage 1: 登录页面与登出功能
**目标**：实现独立登录页和登出功能，重构认证流程
**成功标准**：
- ✅ 未登录用户访问聊天页时自动跳转到登录页
- ✅ 登录页可以通过企微扫码登录
- ✅ 聊天页有登出按钮，点击后清除状态并跳转到登录页
- ✅ 已登录用户访问登录��时自动跳转到聊天页

**测试**：
- 测试未登录访问保护路由是否正确重定向
- 测试登录流程是否完整
- 测试登出后无法访问聊天功能

### Stage 2: 侧边栏 UI 与基础布局
**目标**：实现侧边栏的 UI 结构和响应式布局
**成功标准**：
- ✅ 桌面端侧边栏固定在左侧
- ✅ 移动端侧边栏以抽屉式展开/收起
- ✅ 侧边栏包含"新建会话"按钮和会话列表容器
- ✅ UI 样式符合设计规格

**测试**：
- 测试桌面端和移动端布局是否正确
- 测试侧边栏展开/收起动画是否流畅

### Stage 3: 会话管理功能集成
**目标**：对接 Coze API，实现会话的增删查改
**成功标准**：
- ✅ 登录后自动获取并显示用户的会话列表
- ✅ 点击"新建会话"创建新会话并切换到新会话
- ✅ 点击会话条目加载该会话的历史消息
- ✅ 点击编辑按钮可以重命名会话
- ✅ 点击删除按钮删除指定会话

**测试**：
- 测试会话列表是否正确加载
- 测试新建/切换/重命名/删除会话是否正常工作
- 测试会话数据是否正确存储在 Coze 后端
- 测试重命名的输入验证（空名称、超长名称等）

### Stage 4: 交互优化与错误处理
**目标**：完善用户体验，增加加载状态和错误提示
**成功标准**：
- ✅ 所有异步操作都有加载状态提示
- ✅ 错误情况有友好的提示信息
- ✅ 删除会话有二次确认弹窗
- ✅ 会话标题过长时正确显示省略号和 tooltip

**测试**：
- 测试网络失败时的错误提示
- 测试各种边界情况（空会话列表、超长标题等）

---

## 五、非功能性需求

### 5.1 性能要求
- 会话列表加载时间 < 1秒
- 切换会话的历史消息加载时间 < 2秒
- 侧边栏展开/收起动画流畅（60fps）

### 5.2 兼容性要求
- 桌面端：Chrome 90+, Firefox 88+, Safari 14+
- 移动端：iOS Safari 14+, Android Chrome 90+
- 响应式设计断点：768px（平板/桌面分界）

### 5.3 安全要求
- 所有会话数据通过 HTTPS 传输
- 登出时彻底清除前端和后端的认证信息
- 防止未登录用户访问受保护的 API

---

## 六、待确认事项

1. **Coze API 能力确认**：
   - [ ] Coze API 是否支持根据用户 ID 获取该用户的所有会话列表？
   - [ ] Coze API 返回的会话对象中是否包含"第一条用户消息"？
   - [ ] 如果不包含，是否需要额外调用 `messages.list()` 获取第一条消息？
   - [x] ~~Coze API 是否支持更新会话的标题/名称（重命名功能）？~~ **已确认：支持**

2. **数据迁移**：
   - [ ] 如果现有用户已有会话数据，是否需要迁移到新的会话管理系统？

3. **会话数量限制**：
   - [ ] Coze 是否对单个用户的会话数量有限制？
   - [ ] 是否需要在前端做分页加载？

4. **重命名功能实现方案**：
   - [x] **已确认：采用方案A，直接调用 Coze API 实现重命名功能**

---

## 七、附录

### 7.1 相关文件
- [CLAUDE.md](./CLAUDE.md) - 项目架构文档
- [README.md](./README.md) - 项目说明文档

### 7.2 参考资源
- [Coze API 文档](https://www.coze.com/docs/developer_guides/coze_api_overview)
- [企业微信开发文档](https://developer.work.weixin.qq.com/document/)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)

---

**文档维护**：
- 如有需求变更，请更新本文档并记录变更日志
- 实现完成后，将各阶段的状态更新为"已完成"
